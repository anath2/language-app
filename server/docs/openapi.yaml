openapi: "3.2.0"
info:
  title: Language App API
  version: "1.0.0"
  description: |
    REST API for the Language App. Segments Chinese text into words,
    provides pinyin transliteration, and English translations.
    Includes OCR text extraction, SRS vocabulary review, and segment editing.
  license:
    name: MIT

servers:
  - url: http://localhost:8080
    description: Local development server

security:
  - sessionCookie: []

tags:
  - name: health
    description: Health check
  - name: auth
    description: Authentication
  - name: translations
    description: Translation CRUD and streaming
  - name: texts
    description: Raw text persistence
  - name: events
    description: Interaction event tracking
  - name: vocab
    description: Vocabulary management and SRS
  - name: review
    description: SRS review queue
  - name: segments
    description: Segment re-translation
  - name: admin
    description: Admin operations (profile, progress import/export)
  - name: ocr
    description: OCR text extraction

paths:
  /health:
    get:
      tags: [health]
      summary: Health check
      security: []
      operationId: getHealth
      responses:
        "200":
          description: Server is healthy
          content:
            application/json:
              schema:
                type: object
                required: [status]
                properties:
                  status:
                    type: string
                    example: ok
        "500":
          description: Server error

  /api/auth/login:
    post:
      tags: [auth]
      summary: Log in with password
      security: []
      operationId: login
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [password]
              properties:
                password:
                  type: string
      responses:
        "200":
          description: Login successful. Session cookie is set.
          headers:
            Set-Cookie:
              schema:
                type: string
              description: Session cookie
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok:
                    type: boolean
                    example: true
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          description: Invalid password
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /api/auth/logout:
    post:
      tags: [auth]
      summary: Log out (clear session cookie)
      operationId: logout
      responses:
        "200":
          description: Logout successful
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok:
                    type: boolean
                    example: true
        "401":
          $ref: "#/components/responses/Unauthorized"

  /api/translations:
    post:
      tags: [translations]
      summary: Create a translation job
      operationId: createTranslation
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [input_text, source_type]
              properties:
                input_text:
                  type: string
                source_type:
                  type: string
      responses:
        "200":
          description: Translation job created
          content:
            application/json:
              schema:
                type: object
                required: [translation_id, status]
                properties:
                  translation_id:
                    type: string
                  status:
                    type: string
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
    get:
      tags: [translations]
      summary: List translations
      operationId: listTranslations
      parameters:
        - name: limit
          in: query
          schema:
            type: integer
            default: 20
        - name: offset
          in: query
          schema:
            type: integer
            default: 0
        - name: status
          in: query
          schema:
            type: string
      responses:
        "200":
          description: List of translations
          content:
            application/json:
              schema:
                type: object
                required: [translations, total]
                properties:
                  translations:
                    type: array
                    items:
                      $ref: "#/components/schemas/TranslationSummary"
                  total:
                    type: integer
        "401":
          $ref: "#/components/responses/Unauthorized"

  /api/translations/{translation_id}:
    get:
      tags: [translations]
      summary: Get translation detail
      operationId: getTranslation
      parameters:
        - $ref: "#/components/parameters/translationId"
      responses:
        "200":
          description: Translation detail
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TranslationDetail"
        "404":
          $ref: "#/components/responses/NotFound"
        "401":
          $ref: "#/components/responses/Unauthorized"
    delete:
      tags: [translations]
      summary: Delete a translation
      operationId: deleteTranslation
      parameters:
        - $ref: "#/components/parameters/translationId"
      responses:
        "200":
          description: Translation deleted
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok:
                    type: boolean
        "404":
          $ref: "#/components/responses/NotFound"
        "401":
          $ref: "#/components/responses/Unauthorized"

  /api/translations/{translation_id}/status:
    get:
      tags: [translations]
      summary: Get translation processing status
      operationId: getTranslationStatus
      parameters:
        - $ref: "#/components/parameters/translationId"
      responses:
        "200":
          description: Translation status
          content:
            application/json:
              schema:
                type: object
                required: [translation_id, status]
                properties:
                  translation_id:
                    type: string
                  status:
                    type: string
                  progress:
                    type: ["integer", "null"]
                  total:
                    type: ["integer", "null"]
        "404":
          $ref: "#/components/responses/NotFound"
        "401":
          $ref: "#/components/responses/Unauthorized"

  /api/translations/{translation_id}/stream:
    get:
      tags: [translations]
      summary: Stream translation progress via SSE
      operationId: streamTranslation
      parameters:
        - $ref: "#/components/parameters/translationId"
      responses:
        "200":
          description: |
            Server-Sent Events stream. Events are JSON objects with a `type` field:
            - `start` — translation began, includes `translation_id`, `total`, `paragraphs`
            - `progress` — a segment was translated, includes `current`, `total`, `result`
            - `complete` — all segments done, includes `paragraphs`, `fullTranslation`
            - `error` — an error occurred, includes `message`
          content:
            text/event-stream:
              schema:
                type: string
                description: SSE stream of JSON events
        "401":
          $ref: "#/components/responses/Unauthorized"

  /api/translations/{translation_id}/chat/new:
    post:
      tags: [translations]
      summary: Create a chat message and stream AI response via SSE
      operationId: createTranslationChatMessage
      parameters:
        - $ref: "#/components/parameters/translationId"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ChatCreateRequest"
      responses:
        "200":
          description: |
            Server-Sent Events stream for chat completion. Events are JSON objects:
            - `start` — includes `translation_id`, `chat_id`, `user_message_id`
            - `chunk` — includes incremental `delta` text
            - `complete` — includes `message_id` and final `content`
            - `error` — includes `message`
          content:
            text/event-stream:
              schema:
                type: string
                description: SSE stream of JSON events
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"

  /api/translations/{translation_id}/chat/list:
    get:
      tags: [translations]
      summary: List chat messages for a translation
      operationId: listTranslationChatMessages
      parameters:
        - $ref: "#/components/parameters/translationId"
      responses:
        "200":
          description: Chat thread messages ordered by insertion
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ChatListResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"

  /api/translations/{translation_id}/chat/clear:
    post:
      tags: [translations]
      summary: Clear all chat messages for a translation
      operationId: clearTranslationChatMessages
      parameters:
        - $ref: "#/components/parameters/translationId"
      responses:
        "200":
          description: Chat cleared
          content:
            application/json:
              schema:
                type: object
                required: [ok]
                properties:
                  ok:
                    type: boolean
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"

  /api/texts:
    post:
      tags: [texts]
      summary: Create a text record
      operationId: createText
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [raw_text, source_type]
              properties:
                raw_text:
                  type: string
                source_type:
                  type: string
                metadata:
                  type: object
                  additionalProperties: true
      responses:
        "200":
          description: Text created
          content:
            application/json:
              schema:
                type: object
                required: [id]
                properties:
                  id:
                    type: string
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"

  /api/texts/{text_id}:
    get:
      tags: [texts]
      summary: Get a text record
      operationId: getText
      parameters:
        - name: text_id
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Text record
          content:
            application/json:
              schema:
                type: object
                required: [id, created_at, source_type, raw_text, normalized_text]
                properties:
                  id:
                    type: string
                  created_at:
                    type: string
                    format: date-time
                  source_type:
                    type: string
                  raw_text:
                    type: string
                  normalized_text:
                    type: string
                  metadata:
                    type: object
                    additionalProperties: true
        "404":
          $ref: "#/components/responses/NotFound"
        "401":
          $ref: "#/components/responses/Unauthorized"

  /api/events:
    post:
      tags: [events]
      summary: Create an interaction event
      operationId: createEvent
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [event_type]
              properties:
                event_type:
                  type: string
                text_id:
                  type: ["string", "null"]
                segment_id:
                  type: ["string", "null"]
                payload:
                  type: object
                  additionalProperties: true
      responses:
        "200":
          description: Event created
          content:
            application/json:
              schema:
                type: object
                required: [id]
                properties:
                  id:
                    type: string
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"

  /api/vocab/save:
    post:
      tags: [vocab]
      summary: Save a vocabulary item
      operationId: saveVocab
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [headword, pinyin, english, status]
              properties:
                headword:
                  type: string
                pinyin:
                  type: string
                english:
                  type: string
                text_id:
                  type: ["string", "null"]
                segment_id:
                  type: ["string", "null"]
                snippet:
                  type: ["string", "null"]
                status:
                  type: string
      responses:
        "200":
          description: Vocab item saved
          content:
            application/json:
              schema:
                type: object
                required: [vocab_item_id]
                properties:
                  vocab_item_id:
                    type: string
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"

  /api/vocab/status:
    post:
      tags: [vocab]
      summary: Update vocabulary item status
      operationId: updateVocabStatus
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [vocab_item_id, status]
              properties:
                vocab_item_id:
                  type: string
                status:
                  type: string
      responses:
        "200":
          description: Status updated
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok:
                    type: boolean
        "400":
          $ref: "#/components/responses/BadRequest"
        "404":
          $ref: "#/components/responses/NotFound"
        "401":
          $ref: "#/components/responses/Unauthorized"

  /api/vocab/lookup:
    post:
      tags: [vocab]
      summary: Record a vocabulary lookup
      operationId: recordLookup
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [vocab_item_id]
              properties:
                vocab_item_id:
                  type: string
      responses:
        "200":
          description: Lookup recorded with SRS state
          content:
            application/json:
              schema:
                type: object
                required: [vocab_item_id, opacity, is_struggling]
                properties:
                  vocab_item_id:
                    type: string
                  opacity:
                    type: number
                    format: float
                    description: "1.0 = new/struggling, 0.0 = known"
                  is_struggling:
                    type: boolean
        "400":
          $ref: "#/components/responses/BadRequest"
        "404":
          $ref: "#/components/responses/NotFound"
        "401":
          $ref: "#/components/responses/Unauthorized"

  /api/vocab/srs-info:
    get:
      tags: [vocab]
      summary: Get SRS info for headwords
      operationId: getVocabSRSInfo
      parameters:
        - name: headwords
          in: query
          description: Comma-separated list of headwords
          schema:
            type: string
      responses:
        "200":
          description: SRS info for matching vocab items
          content:
            application/json:
              schema:
                type: object
                required: [items]
                properties:
                  items:
                    type: array
                    items:
                      $ref: "#/components/schemas/VocabSRSItem"
        "401":
          $ref: "#/components/responses/Unauthorized"

  /api/review/words/queue:
    get:
      tags: [review]
      summary: Get SRS review queue
      operationId: getReviewQueue
      parameters:
        - name: limit
          in: query
          schema:
            type: integer
            default: 10
      responses:
        "200":
          description: Review cards due
          content:
            application/json:
              schema:
                type: object
                required: [cards, due_count]
                properties:
                  cards:
                    type: array
                    items:
                      $ref: "#/components/schemas/ReviewCard"
                  due_count:
                    type: integer
        "401":
          $ref: "#/components/responses/Unauthorized"

  /api/review/answer:
    post:
      tags: [review]
      summary: Record a review answer
      operationId: recordReviewAnswer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [vocab_item_id, grade]
              properties:
                vocab_item_id:
                  type: string
                grade:
                  type: integer
      responses:
        "200":
          description: Review answer recorded
          content:
            application/json:
              schema:
                type: object
                required: [vocab_item_id, interval_days, remaining_due]
                properties:
                  vocab_item_id:
                    type: string
                  next_due_at:
                    type: ["string", "null"]
                    format: date-time
                  interval_days:
                    type: number
                    format: float
                  remaining_due:
                    type: integer
        "400":
          $ref: "#/components/responses/BadRequest"
        "404":
          $ref: "#/components/responses/NotFound"
        "401":
          $ref: "#/components/responses/Unauthorized"

  /api/review/words/count:
    get:
      tags: [review]
      summary: Get count of word reviews due
      operationId: getReviewCount
      responses:
        "200":
          description: Count of due word reviews
          content:
            application/json:
              schema:
                type: object
                required: [due_count]
                properties:
                  due_count:
                    type: integer
        "401":
          $ref: "#/components/responses/Unauthorized"

  /api/review/characters/queue:
    get:
      tags: [review]
      summary: Get character SRS review queue
      operationId: getCharacterReviewQueue
      parameters:
        - name: limit
          in: query
          schema:
            type: integer
            default: 10
      responses:
        "200":
          description: Character review cards due
          content:
            application/json:
              schema:
                type: object
                required: [cards, due_count]
                properties:
                  cards:
                    type: array
                    items:
                      $ref: "#/components/schemas/CharacterReviewCard"
                  due_count:
                    type: integer
        "401":
          $ref: "#/components/responses/Unauthorized"

  /api/review/characters/count:
    get:
      tags: [review]
      summary: Get count of character reviews due
      operationId: getCharacterReviewCount
      responses:
        "200":
          description: Count of due character reviews
          content:
            application/json:
              schema:
                type: object
                required: [due_count]
                properties:
                  due_count:
                    type: integer
        "401":
          $ref: "#/components/responses/Unauthorized"

  /api/segments/translate-batch:
    post:
      tags: [segments]
      summary: Translate a batch of segments
      operationId: translateBatch
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [segments]
              properties:
                segments:
                  type: array
                  items:
                    type: string
                context:
                  type: ["string", "null"]
                translation_id:
                  type: ["string", "null"]
                paragraph_idx:
                  type: ["integer", "null"]
      responses:
        "200":
          description: Translated segments
          content:
            application/json:
              schema:
                type: object
                required: [translations]
                properties:
                  translations:
                    type: array
                    items:
                      $ref: "#/components/schemas/SegmentTranslation"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"

  /api/admin/progress/export:
    get:
      tags: [admin]
      summary: Export progress data as JSON file
      operationId: exportProgress
      responses:
        "200":
          description: Progress data as downloadable JSON
          headers:
            Content-Disposition:
              schema:
                type: string
                example: attachment; filename="language_app_progress.json"
          content:
            application/json:
              schema:
                type: object
                description: Exported progress data
        "401":
          $ref: "#/components/responses/Unauthorized"

  /api/admin/progress/import:
    post:
      tags: [admin]
      summary: Import progress data from JSON file
      operationId: importProgress
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required: [file]
              properties:
                file:
                  type: string
                  format: binary
                  description: JSON file with progress data (max 1MB)
      responses:
        "200":
          description: Import successful
          content:
            application/json:
              schema:
                type: object
                required: [success, counts]
                properties:
                  success:
                    type: boolean
                  counts:
                    type: object
                    additionalProperties:
                      type: integer
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"

  /api/admin/profile:
    get:
      tags: [admin]
      summary: Get user profile and vocab stats
      operationId: getProfile
      responses:
        "200":
          description: Profile and vocab stats
          content:
            application/json:
              schema:
                type: object
                required: [vocabStats]
                properties:
                  profile:
                    oneOf:
                      - $ref: "#/components/schemas/UserProfile"
                      - type: "null"
                  vocabStats:
                    $ref: "#/components/schemas/VocabStats"
        "401":
          $ref: "#/components/responses/Unauthorized"
    post:
      tags: [admin]
      summary: Create or update user profile
      operationId: updateProfile
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                email:
                  type: string
                language:
                  type: string
      responses:
        "200":
          description: Profile updated
          content:
            application/json:
              schema:
                type: object
                required: [profile]
                properties:
                  profile:
                    $ref: "#/components/schemas/UserProfile"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"

  /api/extract-text:
    post:
      tags: [ocr]
      summary: Extract text from an image via OCR
      operationId: extractText
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required: [image]
              properties:
                image:
                  type: string
                  format: binary
                  description: Image file (max 10MB)
      responses:
        "200":
          description: Extracted text
          content:
            application/json:
              schema:
                type: object
                required: [text]
                properties:
                  text:
                    type: string
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"

components:
  securitySchemes:
    sessionCookie:
      type: apiKey
      in: cookie
      name: session

  parameters:
    translationId:
      name: translation_id
      in: path
      required: true
      schema:
        type: string

  responses:
    BadRequest:
      description: Invalid request
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
    Unauthorized:
      description: Not authenticated
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"

  schemas:
    ErrorResponse:
      type: object
      required: [detail]
      properties:
        detail:
          type: string

    TranslationSummary:
      type: object
      required: [id, created_at, status, source_type, input_preview]
      properties:
        id:
          type: string
        created_at:
          type: string
          format: date-time
        status:
          type: string
        source_type:
          type: string
        input_preview:
          type: string
          description: First 100 characters of input
        full_translation_preview:
          type: ["string", "null"]
        segment_count:
          type: ["integer", "null"]
        total_segments:
          type: ["integer", "null"]

    TranslationDetail:
      type: object
      required: [id, created_at, status, source_type, input_text]
      properties:
        id:
          type: string
        created_at:
          type: string
          format: date-time
        status:
          type: string
        source_type:
          type: string
        input_text:
          type: string
        full_translation:
          type: ["string", "null"]
        error_message:
          type: ["string", "null"]
        paragraphs:
          type: ["array", "null"]
          items:
            $ref: "#/components/schemas/ParagraphMeta"

    ParagraphMeta:
      type: object
      required: [segment_count, indent, separator]
      properties:
        segment_count:
          type: integer
        indent:
          type: string
        separator:
          type: string

    SegmentTranslation:
      type: object
      required: [segment, pinyin, english]
      properties:
        segment:
          type: string
        pinyin:
          type: string
        english:
          type: string

    ChatCreateRequest:
      type: object
      required: [message]
      properties:
        message:
          type: string
        selected_segment_ids:
          type: array
          items:
            type: string

    ChatMessage:
      type: object
      required: [id, chat_id, translation_id, message_idx, role, content, selected_segment_ids, created_at]
      properties:
        id:
          type: string
        chat_id:
          type: string
        translation_id:
          type: string
        message_idx:
          type: integer
        role:
          type: string
          enum: [user, ai]
        content:
          type: string
        selected_segment_ids:
          type: array
          items:
            type: string
        created_at:
          type: string
          format: date-time

    ChatListResponse:
      type: object
      required: [chat_id, messages]
      properties:
        chat_id:
          type: string
        messages:
          type: array
          items:
            $ref: "#/components/schemas/ChatMessage"

    VocabSRSItem:
      type: object
      required: [vocab_item_id, headword, pinyin, english, opacity, is_struggling, status]
      properties:
        vocab_item_id:
          type: string
        headword:
          type: string
        pinyin:
          type: string
        english:
          type: string
        opacity:
          type: number
          format: float
          description: "1.0 = new/struggling, 0.0 = known"
        is_struggling:
          type: boolean
        status:
          type: string

    ReviewCard:
      type: object
      required: [vocab_item_id, headword, pinyin, english, snippets]
      properties:
        vocab_item_id:
          type: string
        headword:
          type: string
        pinyin:
          type: string
        english:
          type: string
        snippets:
          type: array
          items:
            type: string

    UserProfile:
      type: object
      required: [name, email, language, created_at, updated_at]
      properties:
        name:
          type: string
        email:
          type: string
        language:
          type: string
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    VocabStats:
      type: object
      required: [known, learning, total]
      properties:
        known:
          type: integer
        learning:
          type: integer
        total:
          type: integer

    CharacterReviewCard:
      type: object
      required: [vocab_item_id, character, pinyin, english, example_words]
      properties:
        vocab_item_id:
          type: string
        character:
          type: string
        pinyin:
          type: string
        english:
          type: string
        example_words:
          type: array
          items:
            $ref: "#/components/schemas/CharacterExampleWord"

    CharacterExampleWord:
      type: object
      required: [vocab_item_id, headword, pinyin, english]
      properties:
        vocab_item_id:
          type: string
        headword:
          type: string
        pinyin:
          type: string
        english:
          type: string
